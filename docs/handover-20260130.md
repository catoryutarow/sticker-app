# 引き継ぎ書 2026-01-30

## 今回のセッションで完了した作業

### 1. エクスポート座標システム修正
- **CanvasRenderer.ts**: パーセンテージ座標（0-100）対応済み
- **AudioMixer.ts**: パンニング計算をパーセンテージ座標対応に修正
  - 旧: `(sticker.x - 48) / (sheetWidth - 48)` (ピクセル基準)
  - 新: `(sticker.x / 50) - 1` (パーセンテージ基準)
- **ExportDialog.tsx**: 出力サイズを720x960（3:4比率）に固定
- **VideoExporter.ts**: 不要な`sheetWidth`パラメータ削除

### 2. サーバー設定修正
- **server/index.js**: `app.set('trust proxy', 1)` 追加（Nginxリバースプロキシ対応）

### 3. Resendドメイン認証（完了）
- sirucho.com のDNSレコード設定済み（DKIM, SPF, DMARC）
- Resendダッシュボードで認証完了（緑チェックマーク）
- 本番APIキー作成済み: `re_3eecgYWQ_HZNzBczuYQkvt3BCHoVS1fio`

### 4. EC2環境変数設定
`~/sticker-app/server/.env`:
```
PORT=3001
ALLOWED_ORIGINS=https://sirucho.com,https://www.sirucho.com
JWT_SECRET=sirucho-app-jwt-secret-2026-production-key-random
NODE_ENV=production
FRONTEND_URL=https://sirucho.com
RESEND_API_KEY=re_3eecgYWQ_HZNzBczuYQkvt3BCHoVS1fio
EMAIL_FROM=シール帳 <noreply@sirucho.com>
```

---

## 現在の問題（未解決）

### 403 Forbiddenエラー
- **症状**: ブラウザから `api.sirucho.com/api/auth/me` にアクセスすると403
- **原因調査中**: CORS設定は正しく見えるが、PM2が環境変数を正しく読み込んでいない可能性

### メール認証が動作しない
- **症状**: 新規登録時に `emailVerified: true` になる（本来は`false`であるべき）
- **原因**: `isEmailEnabled()` が `false` を返している
  - `server/routes/auth.js:139` で `isEmailEnabled() ? 0 : 1` により自動認証済みになる
- **根本原因**: PM2が`RESEND_API_KEY`環境変数を読み込んでいない

---

## 試すべき対処法

### 1. PM2を正しいディレクトリから起動し直す
```bash
cd ~/sticker-app/server
pm2 delete sticker-api
pm2 start index.js --name sticker-api --update-env
pm2 save
pm2 logs sticker-api --lines 30
```

### 2. 環境変数が読み込まれているか確認
サーバー起動時に環境変数をログ出力するデバッグコードを一時的に追加：
```javascript
// server/index.js の先頭付近に追加
console.log('RESEND_API_KEY:', process.env.RESEND_API_KEY ? 'SET' : 'NOT SET');
console.log('ALLOWED_ORIGINS:', process.env.ALLOWED_ORIGINS);
```

### 3. ecosystem.config.js を使用
PM2の設定ファイルを作成して確実に環境変数とcwdを指定：
```javascript
// ~/sticker-app/server/ecosystem.config.cjs
module.exports = {
  apps: [{
    name: 'sticker-api',
    script: 'index.js',
    cwd: '/home/ec2-user/sticker-app/server',
    env: {
      NODE_ENV: 'production',
    },
  }],
};
```
起動: `pm2 start ecosystem.config.cjs`

---

## 本番環境情報

### サーバー
- **EC2**: api.sirucho.com
- **SSH**: `ssh -i ~/.ssh/sticker-app-key.pem ec2-user@api.sirucho.com`
- **Nginx設定**: `/etc/nginx/conf.d/api.sirucho.com.conf`
- **PM2プロセス**: `sticker-api`

### フロントエンド
- **Vercel**: sirucho.com
- **自動デプロイ**: GitHub main ブランチにpushで自動

### データベース
- **パス**: `/home/ec2-user/sticker-app/server/data/sticker.db`
- **テーブル数**: 9

---

## Git状況
- **ブランチ**: main
- **最新コミット**: `3c94c53` - fix: Add trust proxy setting for Nginx reverse proxy
- **未コミットの変更**: なし

---

## 残存課題一覧（project-status.mdより）

### 高優先度
1. ~~本番メール認証設定~~ → Resend設定完了、PM2環境変数問題を解決すれば動作するはず
2. DBバックアップ自動化
3. JWT_SECRET本番値設定 → 設定済み

### Phase 3D テスト未完了
- キット共有URL
- 言語切り替え
- モバイル表示
- 認証フロー全般（メール認証問題のため）
- クリエイター機能
- 管理者機能

---

*作成: 2026-01-30 00:40*
