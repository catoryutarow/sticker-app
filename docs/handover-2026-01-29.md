# 引き継ぎ書 - 2026-01-29

## 現在の作業: Phase 3D 本番環境での手動テスト

### 本番環境構成
- **フロントエンド**: Vercel (sirucho.com)
- **バックエンド**: EC2 + Docker + Nginx (api.sirucho.com)
- **DB**: SQLite (`/home/ec2-user/sticker-app/server/data/sticker.db`)
- **動画エンコード**: Docker内のFFmpeg

### 解決済みの問題

| 問題 | 対応 |
|------|------|
| 共有URL 404エラー | `vercel.json` に rewrites 追加 |
| 動画エクスポート失敗（FFmpegなし） | Docker Compose + Alpine FFmpeg |
| 動画エクスポートCORSエラー | `docker-compose.yml` に `ALLOWED_ORIGINS` 追加 |
| 動画エクスポート413エラー | Nginx `client_max_body_size 100M` 設定 |

### 未解決の問題（次のセッションで対応）

#### 1. クリエイター機能 - 画像プレビューが表示されない
- **症状**: キット新規作成時、画像をアップロードしてもプレビューが表示されない
- **表示**: フォールバックの「画像なし」マークが出る
- **推定原因**: DB接続またはファイルアップロード/参照の問題
- **調査ポイント**:
  - `server/routes/kits.js` のアップロード処理
  - 画像ファイルの保存先パス（Docker内とホスト側のマウント）
  - フロントエンドでの画像URL生成

#### 2. クリエイター機能 - 音声ライブラリが空
- **症状**: キット公開時に「ライブラリに音声がない」とされる
- **推定原因**: DB接続または音声ファイル参照の問題
- **調査ポイント**:
  - `server/routes/` の音声関連API
  - DBの `audio_files` テーブルの状態
  - Docker内からのファイルアクセス

#### 3. 動画エクスポート - 台紙フォーマット不整合
- **症状**: エクスポートは成功するが、台紙のフォーマットが正しくない
- **対応**: ローカルでの修正作業が必要

#### 4. 認証機能 - メール送信
- **症状**: メールが届かない、未認証インジケーターが表示されない
- **対応**: Resend本番設定（ドメイン認証）が必要 → Phase 3Eで対応

### EC2での重要なコマンド

```bash
# SSH接続
ssh -i ~/.ssh/sticker-app-key.pem ec2-user@api.sirucho.com

# Dockerログ確認
docker compose logs -f

# Docker再起動
docker compose down && docker compose up -d

# Nginx設定確認
cat /etc/nginx/conf.d/api.sirucho.com.conf
sudo nginx -t && sudo systemctl reload nginx

# DBの中身確認（sqlite3がないのでnode経由）
docker compose exec encoder node -e "const db = require('better-sqlite3')('/app/data/sticker.db'); console.log(db.prepare('SELECT * FROM kits').all());"
```

### Vercel環境変数（設定済み）
- `VITE_API_URL` = `https://api.sirucho.com/api`
- `VITE_ENCODER_URL` = `https://api.sirucho.com`

### 関連ファイル
- `/Users/ryutaro/sticker-app/docs/project-status.md` - 進捗管理
- `/Users/ryutaro/sticker-app/docker-compose.yml` - Docker設定
- `/Users/ryutaro/sticker-app/server/` - バックエンドコード

### 次のアクション
1. 画像アップロード/プレビューの問題を調査・修正
2. 音声ライブラリの問題を調査・修正
3. 上記修正後、EC2にデプロイ
4. 残りのテスト項目を継続
